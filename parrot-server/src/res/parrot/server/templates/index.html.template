<!DOCTYPE HTML>
<html>
	<head>
		<title>Parrot @{parrotVersion} (Zetes @{zetesVersion})</title>
		<style>
			input, textarea, select {
				color: rgba(0, 0, 0, 0.9);
				border-color: rgba(0, 0, 0, 0.2);
				border-width: 1pt;
				padding: 3pt;

				background: -webkit-linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.35)); /* For Safari */
				background: -o-linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.35)); /* For Opera 11.1 to 12.0 */
				background: -moz-linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.35)); /* For Firefox 3.6 to 15 */
				background: linear-gradient(rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.35)); /* Standard syntax */

				font-family: sans-serif;
				font-size: 9pt;
			}
			
			input[type=submit],
			input[type=submit]:active,
			input[type=submit]:hover
			{
				margin: 10pt 0pt; 
				padding: 3pt 10pt; 
				margin-bottom: 0pt;
				border-radius: 5pt;
				border-color: rgba(0, 0, 0, 0);
				font-size: 9pt;
			}

			input[type=submit] {
				background: rgba(0, 0, 0, 0.5);
				color: rgba(255, 255, 255, 0.5);
			}
			input[type=submit]:hover {
				background: rgba(0, 0, 0, 0.55);
				color: rgba(255, 255, 255, 0.6);
			}
			input[type=submit]:active {
				background: rgba(0, 0, 0, 0.6);
				color: rgba(255, 255, 255, 0.7);
			}
			input[type=submit]:disabled {
				background: rgba(0, 0, 0, 0.20);
				color: rgba(255, 255, 255, 0.4);
			}
		</style>
		<script>
			function sortedLocationOf(element, array, start, end) {
				// quicksort()-like function
				start = start || 0;
				end = end || array.length;
				var pivot = parseInt(start + (end - start) / 2, 10);
				while (true) {
					if (end - start <= 1 || array[pivot] === element) {
						return pivot;
					}
					if (array[pivot].valueOf() < element.valueOf()) {
						start = pivot;
					} else {
						end = pivot;
					}
				}
			}
			
			function sortedInsert(element, array) {
				array.splice(sortedLocationOf(element, array) + 1, 0, element);
				return array;
			}
			
			var messages = [];
			
			function setOrderedMessages(newMessages)
			{
				messages = newMessages;
				for (var i = 0; i < messages.length; i++)
				{
					var msgItem = document.createElement('li');
				    var msgItemText = document.createTextNode( messages[i].userId + " | " +
						messages[i].timeMillis + " | " +
						messages[i].text);
				    msgItem.appendChild(msgItemText);
					messagesList.appendChild(msgItem);
				}
			}
			
			function getAllMessages()
			{
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
						var messageResponse = JSON.parse(xmlhttp.responseText);
    					if (xmlhttp.status == 200) {
    						setOrderedMessages(messageResponse);
    					}
						else
						{
							alert(messageResponse.message);
						}
    				}
			  	}
				
				xmlhttp.open("GET", "/api/get_messages", true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}
			
		</script>	
		<script>

	@if{loggedIn}
			function clearCookie(cname) {
 				document.cookie = cname + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
			}

			function logout() {
				logoutButton = document.getElementById("logoutButton");
				logoutButton.disabled = true;
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
    					if (xmlhttp.status == 200) {
    						clearCookie("sessionId");
    					}
    					window.location.reload();
    				}
			  	}
				
				xmlhttp.open("GET", "/api/logout", true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}

			function messageChanged()
			{
				messageTextArea.setAttribute("style", messageTextArea_basicStyle + "; height: 0px;");
				messageTextArea.setAttribute("style", messageTextArea_basicStyle + "; height: " + messageTextArea.scrollHeight + "px;");
				return false;
			}

			function sendMessage() {
				sendMessageButton = document.getElementById("sendMessageButton");
				sendMessageButton.disabled = true;
				messageTextArea.disabled = true;
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
						var messageResponse = JSON.parse(xmlhttp.responseText);
    					if (xmlhttp.status == 200) {
    						messageTextArea.value = "";
    						sendErrorMessage.innerHTML = "";
    					}
						else
						{
							sendErrorMessage.innerHTML = messageResponse.message;
						}
						sendMessageButton.disabled = false;
						messageTextArea.disabled = false;
    				}
			  	}
				
				xmlhttp.open("GET", "/api/add_message?text=" + messageTextArea.value, true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}
	@else
			function setCookie(cname, cvalue, expirationTimeMillis)
			{
				var d = new Date();
				d.setTime(d.getTime() + expirationTimeMillis);
				var expires = "expires=" + d.toUTCString();
				document.cookie = cname + "=" + cvalue + "; " + expires;
			}
			
			function loginFormSetEnabled(enabled)
			{
				loginInput = document.getElementById("loginInput");
				passwordInput = document.getElementById("passwordInput");
				loginButton = document.getElementById("loginButton");
			
				loginInput.disabled = !enabled;
				passwordInput.disabled = !enabled;
				loginButton.disabled = !enabled;
			}

			function login() {
				loginInput = document.getElementById("loginInput");
				passwordInput = document.getElementById("passwordInput");
				loginButton = document.getElementById("loginButton");
				errorMessage = document.getElementById("errorMessage");

				errorMessage.innerHTML = "";
				
				loginFormSetEnabled(false);
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
    					loginResponse = JSON.parse(xmlhttp.responseText);
    					if (xmlhttp.status == 200) {
    						setCookie("sessionId", loginResponse.id, loginResponse.expirationTimeMillis);
    						window.location.reload();
    					} else {
    						loginFormSetEnabled(true);
    						errorMessage.innerHTML = loginResponse.message;
    					}
    				}
			  	}
				
				xmlhttp.open("GET", "/api/login?login=" + loginInput.value + "&password=" + passwordInput.value, true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}
			
			function registrationFormSetEnabled(enabled)
			{
				regUserNameInput.disabled = !enabled;
				regLoginInput.disabled = !enabled;
				regPasswordInput1.disabled = !enabled;
				regPasswordInput2.disabled = !enabled;
				regSubmitButton.disabled = !enabled;
			}
			
			function register() {
				regUserNameInput = document.getElementById("regUserNameInput");
				regLoginInput = document.getElementById("regLoginInput");
				regPasswordInput1 = document.getElementById("regPasswordInput1");
				regPasswordInput2 = document.getElementById("regPasswordInput2");
				regSubmitButton = document.getElementById("regSubmitButton");
				regErrorMessage = document.getElementById("regErrorMessage");
			
				regErrorMessage.innerHTML = "";

				registrationFormSetEnabled(false);

				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
	 				{
						registerResponse = JSON.parse(xmlhttp.responseText);
	 					if (xmlhttp.status == 201)
	 					{
	 						loginInput = document.getElementById("loginInput");
							passwordInput = document.getElementById("passwordInput");
							loginInput.value = regLoginInput.value;
							passwordInput.value = regPasswordInput1.value;
							login();
						} 
						else
						{
							registrationFormSetEnabled(true);
							regErrorMessage.innerHTML = registerResponse.message;
						}
					}
			  	}
			
				xmlhttp.open("GET", 
					"/api/register?name=" + regUserNameInput.value + 
								"&login=" + regLoginInput.value + 
								"&password1=" + regPasswordInput1.value + 
								"&password2=" + regPasswordInput2.value, true);
				xmlhttp.send();

				return false;	// Don't actually submit anything
			}
	@end
		</script>
	</head>
	<body>
	
	@if{loggedIn}
		<div>
			<p>User <span id="userName">@{userName}</span> is logged in</p>
			<form>
				<p>
					<input id="logoutButton" type="submit" onclick="return logout();" value="Logout" />
				</p>
			</form>
		</div>
		
		<div>
			<ul id="messagesList">
				<li>Message here</li>
			</ul>
			<form>
				<textarea id="messageTextArea" style="width: 300pt; resize: none; overflow: hidden;" oninput="messageChanged();" ></textarea>
				<input id="sendMessageButton" type="submit" onclick="return sendMessage();" value="Send" />
			</form>
			<p id="sendErrorMessage" />
		</div>
	@else	
		<div>
			<h2>Log in or register</h2>
			<h3>Login</h3>
			<form>
				<p>
					Login: 		<input id="loginInput" type="text"/><br/>
					Password: 	<input id="passwordInput" type="password"/><br/>
					<input id="loginButton" type="submit" onclick="return login();" value="Log in" />
				</p>
				<p id="errorMessage" />
			</form>

			<h3>Registration</h3>
			<form>
				<p>
					User name: 	<input id="regUserNameInput" type="text"/><br/>
					Login: 		<input id="regLoginInput" type="text"/><br/>
					Password: 	<input id="regPasswordInput1" type="password"/><br/>
					Confirm: 	<input id="regPasswordInput2" type="password"/><br/>
					<input id="regSubmitButton" type="submit" onclick="return register();" value="Register" />
				</p>
				<p id="regErrorMessage" />
			</form>
		</div>
	@end
		<script type="text/javascript">
			messageTextArea = document.getElementById("messageTextArea");
			messageTextArea_basicStyle = messageTextArea.getAttribute("style");
			sendErrorMessage = document.getElementById("sendErrorMessage");
			messagesList = document.getElementById("messagesList");
			messageChanged();
	@if{loggedIn}
			getAllMessages();
	@end
		</script>
	</body>
</html>