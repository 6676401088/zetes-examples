<!DOCTYPE HTML>
<html>
	<head>
		<title>Parrot @{parrotVersion} (Zetes @{zetesVersion})</title>
		<link rel="stylesheet" type="text/css" href="/css/main.css"/>
		<script>
			ajaxTimeout = 10000;
			messagesLoadInterval = 200;
			
			function sortedLocationOf(element, array, start, end) {
				// quicksort()-like function
				start = start || 0;
				end = end || array.length;
				var pivot = parseInt(start + (end - start) / 2, 10);
				while (true) {
					if (end - start <= 1 || array[pivot] === element) {
						return pivot;
					}
					if (array[pivot].valueOf() < element.valueOf()) {
						start = pivot;
					} else {
						end = pivot;
					}
				}
			}
			
			function sortedInsert(element, array) {
				array.splice(sortedLocationOf(element, array) + 1, 0, element);
				return array;
			}
			
			var messages = [];
			
			function appendOrderedMessages(newMessages, users)
			{
				messages = messages.concat(newMessages);

				// Clearing messagesList
				//while (messagesList.firstChild) {
				//	messagesList.removeChild(messagesList.firstChild);
				//}
				
				for (var i = 0; i < newMessages.length; i++)
				{
					var msgItem = document.createElement('li');
					msgItem.className = "message";
					{
						var msgUser = document.createElement('span');
						msgUser.className = "msgUser";
						{
					    	var msgUserText = document.createTextNode(users[messages[i].userId].name);
					    	msgUser.appendChild(msgUserText);
					    }
						var msgTime = document.createElement('span');
						msgTime.className = "msgTime";
						{
					    	var msgTimeText = document.createTextNode(new Date(messages[i].timeMillis).toTimeString());
					    	msgTime.appendChild(msgTimeText);
					    }
						var msgText = document.createElement('div');
						msgText.className = "msgText";
						{
					    	var msgTextText = document.createTextNode(messages[i].text);
					    	msgText.appendChild(msgTextText);
					    }
					    	
					    msgItem.appendChild(msgUser);
					    msgItem.appendChild(msgTime);
					    msgItem.appendChild(msgText);
				    }
					messagesList.appendChild(msgItem);
				}
			}
			
			function getUsersForMessages(msgs)
			{
				if (msgs.length > 0)
				{
					
					// Collecting user ids
					var userIds = [];
					for (var i = 0; i < msgs.length; i++)
					{
						if (userIds.indexOf(msgs[i].userId) == -1)
						{
							userIds.push(msgs[i].userId);
						}
					}
					
					var userIdsStr = "";
					for (var i = 0; i < userIds.length - 1; i++)
					{
						userIdsStr += userIds[i] + ",";
					}
					if (userIds.length > 0)
					{
						userIdsStr += userIds[userIds.length - 1];
					}
			
					var xmlhttp = new XMLHttpRequest();
					xmlhttp.onreadystatechange = function()
					{
						if (xmlhttp.readyState == 4)
   		 				{
							var usersResponse = { message: "No answer from the server" };
							if (xmlhttp.responseText != "") {
								usersResponse = JSON.parse(xmlhttp.responseText);
							}

							if (xmlhttp.status == 200) {
								appendOrderedMessages(msgs, usersResponse);
							}
							else
							{
								sendErrorMessage.innerHTML = usersResponse.message;
							}
    					}
				  	}
				
					xmlhttp.timeout = ajaxTimeout;
					xmlhttp.ontimeout = function ()
					{ 
						sendErrorMessage.innerHTML = "Can't connect to the server.";
					}
				
					xmlhttp.open("GET", "/api/users?ids=" + userIdsStr, true);
				
					xmlhttp.send();
				}
				
				return false;	// Don't actually submit anything
			}
			
			serverTimeMillis = 0;
			function getLatestMessages()
			{
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
						if (xmlhttp.responseText != "") {
							var messagesSliceResponse = JSON.parse(xmlhttp.responseText);
							
							if (xmlhttp.status == 200) {
								serverTimeMillis = messagesSliceResponse.serverTimeMillis;
								messages = messagesSliceResponse.messages;
								getUsersForMessages(messages);
							}
							else
							{
								sendErrorMessage.innerHTML = messagesSliceResponse.message;
							}
						}
						
						setTimeout("getLatestMessages()", messagesLoadInterval);
    				}
			  	}
				
				xmlhttp.timeout = ajaxTimeout;
				xmlhttp.ontimeout = function ()
				{ 
					sendErrorMessage.innerHTML = "Can't connect to the server.";
					setTimeout("getLatestMessages()", messagesLoadInterval * 5);
				}
				
				xmlhttp.open("GET", "/api/messages_since?sinceTimeMillis=" + serverTimeMillis, true);
				
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}
			
		</script>	
		<script>

	@if{loggedIn}
			function clearCookie(cname) {
 				document.cookie = cname + '=; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
			}

			function logout() {
				logoutButton = document.getElementById("logoutButton");
				logoutButton.disabled = true;
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.timeout = ajaxTimeout;

				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
    					if (xmlhttp.status == 200) {
    						clearCookie("sessionId");
    					}
    					window.location.reload();
    				}
			  	}
				
				xmlhttp.ontimeout = function ()
				{ 
					alert("Can't connect to the server.");
					logoutButton.disabled = false;
				}
				
				xmlhttp.open("GET", "/api/logout", true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}

			function messageChanged()
			{
				messageTextArea.setAttribute("style", messageTextArea_basicStyle + "; height: 0px;");
				messageTextArea.setAttribute("style", messageTextArea_basicStyle + "; height: " + messageTextArea.scrollHeight + "px;");
				return false;
			}

			function sendMessage() {
				sendMessageButton = document.getElementById("sendMessageButton");
				sendMessageButton.disabled = true;
				messageTextArea.disabled = true;
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.timeout = ajaxTimeout;

				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
						var messageResponse = { message: "No answer from the server" };
						if (xmlhttp.responseText != "") {
							messageResponse = JSON.parse(xmlhttp.responseText);
						}
						
    					if (xmlhttp.status == 200) {
    						messageTextArea.value = "";
    						sendErrorMessage.innerHTML = "";
    					}
						else
						{
							sendErrorMessage.innerHTML = messageResponse.message;
						}
						sendMessageButton.disabled = false;
						messageTextArea.disabled = false;
    				}
			  	}
				
				xmlhttp.ontimeout = function ()
				{ 
					alert("Can't connect to the server.");
					sendMessageButton.disabled = false;
					messageTextArea.disabled = false;
				}
				
				xmlhttp.open("GET", "/api/add_message?text=" + messageTextArea.value, true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}
	@else
			function setCookie(cname, cvalue, expirationTimeMillis)
			{
				var d = new Date();
				d.setTime(d.getTime() + expirationTimeMillis);
				var expires = "expires=" + d.toUTCString();
				document.cookie = cname + "=" + cvalue + "; " + expires;
			}
			
			function loginFormSetEnabled(enabled)
			{
				loginInput = document.getElementById("loginInput");
				passwordInput = document.getElementById("passwordInput");
				loginButton = document.getElementById("loginButton");
			
				loginInput.disabled = !enabled;
				passwordInput.disabled = !enabled;
				loginButton.disabled = !enabled;
			}

			function login() {
				loginInput = document.getElementById("loginInput");
				passwordInput = document.getElementById("passwordInput");
				loginButton = document.getElementById("loginButton");
				errorMessage = document.getElementById("errorMessage");

				errorMessage.innerHTML = "";
				
				loginFormSetEnabled(false);
				
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.timeout = ajaxTimeout;

				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
    				{
						var loginResponse = { message: "No answer from the server" };
						if (xmlhttp.responseText != "")	{
							loginResponse = JSON.parse(xmlhttp.responseText);
						}

    					if (xmlhttp.status == 200) {
    						setCookie("sessionId", loginResponse.id, loginResponse.expirationTimeMillis);
    						window.location.reload();
    					} else {
    						loginFormSetEnabled(true);
    						errorMessage.innerHTML = loginResponse.message;
    					}
    				}
			  	}
				
				xmlhttp.ontimeout = function ()
				{ 
					loginFormSetEnabled(true);
					errorMessage.innerHTML = "Can't connect to the server.";
				}
				
				xmlhttp.open("GET", "/api/login?login=" + loginInput.value + "&password=" + passwordInput.value, true);
				xmlhttp.send();
				
				return false;	// Don't actually submit anything
			}
			
			function registrationFormSetEnabled(enabled)
			{
				regUserNameInput.disabled = !enabled;
				regLoginInput.disabled = !enabled;
				regPasswordInput1.disabled = !enabled;
				regPasswordInput2.disabled = !enabled;
				regSubmitButton.disabled = !enabled;
			}
			
			function register() {
				regUserNameInput = document.getElementById("regUserNameInput");
				regLoginInput = document.getElementById("regLoginInput");
				regPasswordInput1 = document.getElementById("regPasswordInput1");
				regPasswordInput2 = document.getElementById("regPasswordInput2");
				regSubmitButton = document.getElementById("regSubmitButton");
				regErrorMessage = document.getElementById("regErrorMessage");
			
				regErrorMessage.innerHTML = "";

				registrationFormSetEnabled(false);

				var xmlhttp = new XMLHttpRequest();
				xmlhttp.onreadystatechange = function()
				{
					if (xmlhttp.readyState == 4)
	 				{
						var registerResponse = { message: "No answer from the server" };
						if (xmlhttp.responseText != "") {
							registerResponse = JSON.parse(xmlhttp.responseText);
						}
						
	 					if (xmlhttp.status == 201)
	 					{
	 						loginInput = document.getElementById("loginInput");
							passwordInput = document.getElementById("passwordInput");
							loginInput.value = regLoginInput.value;
							passwordInput.value = regPasswordInput1.value;
							login();
						} 
						else
						{
							registrationFormSetEnabled(true);
							regErrorMessage.innerHTML = registerResponse.message;
						}
					}
			  	}
			
				xmlhttp.open("GET", 
					"/api/register?name=" + regUserNameInput.value + 
								"&login=" + regLoginInput.value + 
								"&password1=" + regPasswordInput1.value + 
								"&password2=" + regPasswordInput2.value, true);
				xmlhttp.send();

				return false;	// Don't actually submit anything
			}
	@end
		</script>
	</head>
	<body>
		<div class="logoutPanel">
			<img class="userIcon" style="background-image: url('/parrot_color')" src="/images/parrot_bw.png" />
	@if{loggedIn}
			<form class="logoutForm">
				<span class="userLoggedIn">User <span class="userName" id="userName">@{userName}</span> is logged in</span>
				<input class="logout" id="logoutButton" type="submit" onclick="return logout();" value="Logout" />
			</form>
	@else	
			<h2>Log in or register</h2>
		</div>
		<div>
			<h3>Login</h3>
			<form>
				<p>
					Login: 		<input id="loginInput" type="text"/><br/>
					Password: 	<input id="passwordInput" type="password"/><br/>
					<input id="loginButton" type="submit" onclick="return login();" value="Log in" />
				</p>
				<p id="errorMessage" />
			</form>

			<h3>Registration</h3>
			<form>
				<p>
					User name: 	<input id="regUserNameInput" type="text"/><br/>
					Login: 		<input id="regLoginInput" type="text"/><br/>
					Password: 	<input id="regPasswordInput1" type="password"/><br/>
					Confirm: 	<input id="regPasswordInput2" type="password"/><br/>
					<input id="regSubmitButton" type="submit" onclick="return register();" value="Register" />
				</p>
				<p id="regErrorMessage" />
			</form>
		</div>
	@end
		<div>
			<ul class="messages" id="messagesList">
				<!-- Messages go here -->
			</ul>
	@if{loggedIn}
			<form>
				<textarea id="messageTextArea" style="width: 300pt; resize: none; overflow: hidden;" oninput="messageChanged();" ></textarea>
				<input id="sendMessageButton" type="submit" onclick="return sendMessage();" value="Send" />
			</form>
			<p id="sendErrorMessage" />
	@end
		</div>
	
	
		<script type="text/javascript">
	@if{loggedIn}
			messageTextArea = document.getElementById("messageTextArea");
			messageTextArea_basicStyle = messageTextArea.getAttribute("style");
			sendErrorMessage = document.getElementById("sendErrorMessage");
			messageChanged();
	@end
			messagesList = document.getElementById("messagesList");
			getLatestMessages();
		</script>
	</body>
</html>